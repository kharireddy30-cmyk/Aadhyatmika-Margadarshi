<!DOCTYPE html>
<html lang="te">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ఆధ్యాత్మిక మార్గదర్శి</title>
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="మార్గదర్శి">
    <link rel="apple-touch-icon" href="https://i.ibb.co/6Pqj45q/icon.png">
    <link rel="shortcut icon" href="https://i.ibb.co/6Pqj45q/icon.png">
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(135deg, #1f2937, #111827);
            color: #f9fafb;
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 1rem;
        }
        .container {
            width: 100%;
            max-width: 768px;
            background-color: #1f2937;
            border-radius: 1.5rem;
            padding: 2rem;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.2), 0 10px 10px -5px rgba(0, 0, 0, 0.1);
        }
        .text-gradient {
            background: linear-gradient(45deg, #9333ea, #c084fc);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        .btn {
            background-color: #6d28d9;
            color: white;
            padding: 0.75rem 1.5rem;
            border-radius: 9999px;
            font-weight: 600;
            transition: background-color 0.3s;
        }
        .btn:hover {
            background-color: #5b21b6;
        }
        .input-box {
            background-color: #374151;
            color: #d1d5db;
            border: 1px solid #4b5563;
            padding: 0.75rem 1rem;
            border-radius: 0.75rem;
            width: 100%;
        }
        .icon-btn {
            background-color: #6d28d9;
            color: white;
            width: 48px;
            height: 48px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 9999px;
            transition: background-color 0.3s;
        }
        .icon-btn:hover {
            background-color: #5b21b6;
        }
    </style>
</head>
<body class="bg-gray-900 text-gray-100 flex items-center justify-center min-h-screen p-4">

<div class="container mx-auto p-6 md:p-10 rounded-3xl shadow-xl border border-gray-700">
    <h1 class="text-4xl md:text-5xl font-extrabold text-center mb-4 text-gradient">ఆధ్యాత్మిక మార్గదర్శి</h1>
    <p class="text-center text-gray-400 mb-8">జ్యోతిష్యం, ఆధ్యాత్మికత, మరియు జీవనశైలి గురించి మీ ప్రశ్నలు అడగండి.</p>

    <div class="flex flex-col md:flex-row gap-4 mb-6 items-center">
        <textarea id="questionInput" rows="2" class="input-box flex-grow placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-purple-500 resize-none" placeholder="మీ ప్రశ్న ఇక్కడ టైప్ చేయండి..."></textarea>
        <div class="flex gap-2 shrink-0 md:mt-0">
            <button id="askButton" class="btn">సమాధానం అడగండి</button>
            <button id="micButton" class="icon-btn">
                <i class="fas fa-microphone"></i>
            </button>
            <button id="speakerButton" class="icon-btn hidden">
                <i class="fas fa-volume-up"></i>
            </button>
        </div>
    </div>

    <div id="responseContainer" class="p-6 bg-gray-800 rounded-2xl border border-gray-700 transition-all duration-300">
        <div id="loadingMessage" class="hidden text-center text-purple-400">
            <div class="animate-spin inline-block h-8 w-8 rounded-full border-4 border-t-4 border-purple-500 border-opacity-75"></div>
            <p class="mt-2">సమాధానం జెనరేట్ అవుతోంది, దయచేసి వేచి ఉండండి...</p>
        </div>
        <p id="answerText" class="text-gray-300 leading-relaxed"></p>
        <div id="errorMessage" class="hidden text-red-400 font-medium mt-2"></div>
    </div>
</div>

<script>
    const askButton = document.getElementById('askButton');
    const questionInput = document.getElementById('questionInput');
    const answerText = document.getElementById('answerText');
    const loadingMessage = document.getElementById('loadingMessage');
    const errorMessage = document.getElementById('errorMessage');
    const micButton = document.getElementById('micButton');
    const speakerButton = document.getElementById('speakerButton');

    const API_KEY = "AIzaSyCxdGLb9g83GVcWhbp3BzCBjxM2m2wCK7I";
    const API_URL = "https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent";

    const systemPrompt = `
        మీరు జ్యోతిష్యం, ఆధ్యాత్మికత, ఆయుర్వేదం, ఆహారపు అలవాట్లు మరియు క్రమశిక్షణతో కూడిన పెంపకం గురించి సలహాలు ఇచ్చే ఒక జ్ఞానవంతుడైన మార్గదర్శి. మీరు ఒక "మూడో నేత్రం" లాగా వ్యవహరిస్తారు. మీరు జ్యోతిష్య శాస్త్రంలో ఖచ్చితమైన గణనలు ఇవ్వలేరు, కానీ జ్యోతిష్య సూత్రాలను, ఆధ్యాత్మిక జ్ఞానాన్ని, మరియు ఆరోగ్యకరమైన జీవనశైలిని కలిపి ఒక సమగ్రమైన సమాధానం ఇస్తారు.
        మీరు ఈ కింది అంశాలపై సలహాలు ఇస్తారు:
        1. జ్యోతిష్యం: 12 రాశులు, 27 నక్షత్రాలు, 9 గ్రహాల గురించి సాధారణ వివరణలు. ఒక వ్యక్తి పుట్టిన సమయం తెలియకపోయినా, వారి పుట్టిన రోజు ఆధారంగా సాధారణ జ్యోతిష్య సూత్రాలను వివరిస్తారు.
        2. ఆధ్యాత్మిక మార్గం: ధ్యానం, ప్రశాంతత, మరియు మనసును నియంత్రించటం వంటి వాటిపై సలహాలు.
        3. ఆయుర్వేదం మరియు ఆహారం: సమతుల్యమైన మరియు ఆరోగ్యకరమైన ఆహారపు అలవాట్ల గురించి మార్గదర్శనం.
        4. పిల్లల పెంపకం: తల్లిదండ్రులకు చిన్నతనం నుంచే పిల్లలను క్రమశిక్షణగా, పద్ధతిగా పెంచడం గురించి విలువైన సలహాలు.

        మీరు ఎప్పుడూ ప్రశాంతంగా, ప్రోత్సాహకరంగా మరియు సహాయకరంగా సమాధానం ఇస్తారు.
    `;

    let utterance = null;
    let isSpeaking = false;
    let maleVoice = null;
    const lang = 'te-IN';
    const voicesLoaded = new Promise(resolve => {
        if (window.speechSynthesis.getVoices().length > 0) {
            resolve();
        } else {
            window.speechSynthesis.onvoiceschanged = () => resolve();
        }
    });

    function cleanMarkdown(text) {
        if (!text) return "";
        let cleanedText = text;
        cleanedText = cleanedText.replace(/###\s|##\s|#\s/g, '');
        cleanedText = cleanedText.replace(/\*\*(.*?)\*\*/g, '$1');
        cleanedText = cleanedText.replace(/\*(.*?)\*/g, '$1');
        cleanedText = cleanedText.replace(/^-+\s/gm, '');
        cleanedText = cleanedText.replace(/^\s*\*\s/gm, '');
        cleanedText = cleanedText.replace(/_(\S.*?)_/g, '$1');
        return cleanedText.trim();
    }

    voicesLoaded.then(() => {
        const voices = window.speechSynthesis.getVoices();
        for (let i = 0; i < voices.length; i++) {
            if (voices[i].lang === lang && (voices[i].name.includes('male') || voices[i].name.includes('Male'))) {
                maleVoice = voices[i];
                break;
            }
        }
    });

    askButton.addEventListener('click', async () => {
        const userQuestion = questionInput.value.trim();
        if (userQuestion === "") {
            errorMessage.textContent = "దయచేసి మీ ప్రశ్నను టైప్ చేయండి.";
            errorMessage.classList.remove('hidden');
            return;
        }

        if (window.speechSynthesis.speaking) {
            window.speechSynthesis.cancel();
            isSpeaking = false;
        }

        answerText.textContent = "";
        errorMessage.classList.add('hidden');
        loadingMessage.classList.remove('hidden');
        speakerButton.classList.add('hidden');
        
        try {
            const payload = {
                contents: [{ parts: [{ text: userQuestion }] }],
                tools: [{ "google_search": {} }],
                systemInstruction: {
                    parts: [{ text: systemPrompt }]
                },
            };

            const response = await fetch(`${API_URL}?key=${API_KEY}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });

            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }

            const result = await response.json();
            let text = result?.candidates?.[0]?.content?.parts?.[0]?.text;

            if (text) {
                const cleanedText = cleanMarkdown(text);
                answerText.textContent = cleanedText;
                speakerButton.classList.remove('hidden');
            } else {
                throw new Error("సమాధానం పొందడంలో సమస్య వచ్చింది.");
            }

        } catch (error) {
            errorMessage.textContent = `ఒక లోపం సంభవించింది: ${error.message}`;
            errorMessage.classList.remove('hidden');
        } finally {
            loadingMessage.classList.add('hidden');
        }
    });

    speakerButton.addEventListener('click', () => {
        if (isSpeaking) {
            window.speechSynthesis.cancel();
            isSpeaking = false;
            speakerButton.querySelector('i').className = 'fas fa-volume-up';
        } else {
            const textToSpeak = answerText.textContent;
            if (textToSpeak) {
                utterance = new SpeechSynthesisUtterance(textToSpeak);
                utterance.lang = lang;

                if (maleVoice) {
                    utterance.voice = maleVoice;
                }

                window.speechSynthesis.speak(utterance);
                isSpeaking = true;
                speakerButton.querySelector('i').className = 'fas fa-volume-mute';

                utterance.onend = () => {
                    isSpeaking = false;
                    speakerButton.querySelector('i').className = 'fas fa-volume-up';
                };
            }
        }
    });

    micButton.addEventListener('click', () => {
        if (!('webkitSpeechRecognition' in window)) {
            errorMessage.textContent = "వాయిస్ రికార్డింగ్ మీ బ్రౌజర్‌లో అందుబాటులో లేదు. దయచేసి Chrome వంటి బ్రౌజర్‌ని ఉపయోగించండి.";
            errorMessage.classList.remove('hidden');
            return;
        }

        // పర్మిషన్ అడగడం
        navigator.mediaDevices.getUserMedia({ audio: true })
            .then(stream => {
                const recognition = new webkitSpeechRecognition();
                recognition.lang = lang;
                recognition.interimResults = false;
                recognition.maxAlternatives = 1;

                recognition.start();
                micButton.classList.add('text-red-500');

                recognition.onresult = (event) => {
                    const transcript = event.results[0][0].transcript;
                    questionInput.value = transcript;
                    micButton.classList.remove('text-red-500');
                };

                recognition.onerror = (event) => {
                    micButton.classList.remove('text-red-500');
                    errorMessage.textContent = `వాయిస్ రికార్డింగ్‌లో లోపం వచ్చింది. దయచేసి మళ్ళీ ప్రయత్నించండి. Error: ${event.error}`;
                    errorMessage.classList.remove('hidden');
                };

                recognition.onend = () => {
                    micButton.classList.remove('text-red-500');
                    // మైక్రోఫోన్ వాడుకం పూర్తయ్యాక స్ట్రీమ్‌ను ఆపడం
                    stream.getTracks().forEach(track => track.stop());
                };
            })
            .catch(err => {
                errorMessage.textContent = `మైక్రోఫోన్ అనుమతి నిరాకరించబడింది: ${err.name}`;
                errorMessage.classList.remove('hidden');
            });
    });
</script>

</body>
</html>
